<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reine Lindqvist's Musikquiz - Avancerad</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            padding: 30px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1DB954; /* Spotify Green */
            text-align: center;
            margin-bottom: 25px;
        }
        .control-group {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .control-group h3 {
            margin-top: 0;
            color: #1DB954;
        }
        .decade-choices, .player-setup {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        label {
            cursor: pointer;
        }
        input[type="checkbox"] {
            margin-right: 5px;
        }
        input[type="number"], button {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
        }
        button {
            background-color: #1DB954;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #17a447;
        }
        .player-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }
        .player-list li {
            padding: 5px 0;
            border-bottom: 1px dotted #eee;
        }
        .quiz-output {
            padding: 20px;
            border: 2px solid #eee;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .guess-area {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        .guess-area input {
            display: block;
            width: 90%;
            margin-bottom: 10px;
        }
        .error {
            color: #ff4d4d;
            font-weight: bold;
        }
        .success {
            color: #1DB954;
            font-weight: bold;
        }
        audio {
            width: 100%;
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üéµ Musikquiz: Konfigurera Spel</h1>

        <div class="control-group">
            <h3>Spelare & √Örtionden</h3>
            <div class="player-setup">
                <label for="num-players">Antal spelare (1-10):</label>
                <input type="number" id="num-players" min="1" max="10" value="1" onchange="setupPlayers()">
            </div>
            <ul id="player-scores" class="player-list">
                </ul>
        </div>

        <div class="control-group">
            <h3>V√§lj √Örtionden</h3>
            <div id="decade-choices" class="decade-choices">
                <label><input type="checkbox" value="60s"> 60-talet</label>
                <label><input type="checkbox" value="70s"> 70-talet</label>
                <label><input type="checkbox" value="80s"> 80-talet</label>
                <label><input type="checkbox" value="90s"> 90-talet</label>
                <label><input type="checkbox" value="00s"> 2000-talet</label>
                <label><input type="checkbox" value="10s"> 2010-talet</label>
                <label><input type="checkbox" value="20s"> 2020-talet</label>
            </div>
            <button onclick="startNewRound()" style="margin-top: 15px;">Starta Ny Quiz-Runda</button>
        </div>

        <div id="quiz-output" class="quiz-output">
            <p>V√§lj √•rtionde/n och antal spelare. Klicka p√• **Starta Ny Quiz-Runda**.</p>
        </div>
        
        <div id="guess-section" class="guess-area" style="display: none;">
            <h3>Gissning & Po√§ng</h3>
            <p>L√•ten spelas upp. Ange dina gissningar nedan:</p>
            
            <label for="guess-artist">Artist:</label>
            <input type="text" id="guess-artist">
            
            <label for="guess-title">L√•ttitel:</label>
            <input type="text" id="guess-title">
            
            <label for="guess-year">Utgivnings√•r:</label>
            <input type="number" id="guess-year" min="1900" max="2030">
            
            <label for="current-player-select">Vem gissade?</label>
            <select id="current-player-select"></select>
            
            <button onclick="submitGuess()">R√§tta Gissning & Dela ut Po√§ng</button>
        </div>
    </div>

    <script>
        // *******************************************************************
        // KONTROLLPUNKT 1: ERS√ÑTT DENNA STR√ÑNG MED DIN FULLST√ÑNDIGA ACCESS TOKEN!
        // (Token √§r giltig i ca 1 timme)
        const SPOTIFY_ACCESS_TOKEN = "BQBOAEBL2E0h4s6-p5BckzcnSOEt53yp7lEaraTh_nYAHOAKQ_8f5oDUej39nCq92t8oy3OoWBW7gM12ZAfetE4ucKFCsnxe4GYIdS-4-3tI9oRmbmcrYXbDI_N...
"; 
        // *******************************************************************

        // Globala variabler f√∂r speldata
        let players = [];
        let currentAnswer = null; // Lagrar facit f√∂r den aktuella l√•ten
        
        // 1. Spelliste-ID per √Örtionde (Spotify 'All Out' spellistor)
        const playlistSources = {
            '60s': '37i9dQZF1DXcKqP3JdK0pQ', 
            '70s': '37i9dQZF1DWTJg7XNnKFE3', 
            '80s': '37i9dQZF1DXcBWIGoYBM5M', 
            '90s': '37i9dQZF1DXbTjV1dE9zY7', 
            '00s': '37i9dQZF1DX4oNzlhCrbxM', 
            '10s': '37i9dQZF1DX5BAW6M0K4Vf', 
            '20s': '37i9dQZF1DXcBWIGoYBM5M', // Today's Top Hits
        };
        const MAX_SONGS_TO_CHECK = 100; 

        // Initialiserar spelarlistan vid start
        setupPlayers(); 

        /** * Hanterar inst√§llning och visning av spelare
         */
        function setupPlayers() {
            const num = parseInt(document.getElementById('num-players').value);
            const playerList = document.getElementById('player-scores');
            const playerSelect = document.getElementById('current-player-select');
            
            // Beh√•ller po√§ngen f√∂r befintliga spelare
            let existingPlayers = players.slice(0, num);
            players = [];
            playerList.innerHTML = '';
            playerSelect.innerHTML = '';

            for (let i = 1; i <= num; i++) {
                const name = existingPlayers[i - 1]?.name || `Spelare ${i}`;
                const score = existingPlayers[i - 1]?.score || 0;

                players.push({ id: i, name: name, score: score });
                
                // Uppdatera spelarlistan i gr√§nssnittet
                playerList.innerHTML += `<li id="player-${i}"><strong>${name}:</strong> ${score} po√§ng</li>`;
                
                // Uppdatera spelarv√§ljaren f√∂r gissningar
                playerSelect.innerHTML += `<option value="${i}">${name}</option>`;
            }
        }

        /**
         * V√§ljer ett slumpm√§ssigt √•rtionde fr√•n de markerade.
         */
        function selectRandomDecade() {
            const checkboxes = document.querySelectorAll('#decade-choices input[type="checkbox"]:checked');
            if (checkboxes.length === 0) return null;

            const selectedDecades = Array.from(checkboxes).map(cb => cb.value);
            const randomIndex = Math.floor(Math.random() * selectedDecades.length);
            return selectedDecades[randomIndex];
        }

        /**
         * Startar en ny omg√•ng genom att h√§mta en l√•t.
         */
        async function startNewRound() {
            const selectedDecade = selectRandomDecade();
            const outputElement = document.getElementById('quiz-output');
            
            document.getElementById('guess-section').style.display = 'none'; // D√∂lj gissningsf√§ltet
            currentAnswer = null; // √Öterst√§ll facit

            if (!selectedDecade) {
                outputElement.innerHTML = `<p class="error">‚ùå V√§nligen v√§lj minst ett √•rtionde att spela fr√•n.</p>`;
                return;
            }
            if (SPOTIFY_ACCESS_TOKEN === "BQBOAEBL2E0h4s6-p5BckzcnSOEt53yp7lEaraTh_nYAHOAKQ_8f5oDUej39nCq92t8oy3OoWBW7gM12ZAfetE4ucKFCsnxe4GYIdS-4-3tI9oRmbmcrYXbDI_N...
" || SPOTIFY_ACCESS_TOKEN === "") {
                outputElement.innerHTML = `<p class="error">‚ùå FEL: V√§nligen klistra in din Spotify Access Token i koden.</p>`;
                return;
            }
            
            const playlistId = playlistSources[selectedDecade];
            outputElement.innerHTML = `<p class="success">Laddar l√•t fr√•n **${selectedDecade}** (Playlist ID: ${playlistId}). V√§nligen v√§nta...</p>`;

            try {
                // 2. RIKTIGT API-ANROP till Spotify
                const apiUrl = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=${MAX_SONGS_TO_CHECK}`;
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${SPOTIFY_ACCESS_TOKEN}` 
                    }
                });

                if (response.status === 401) {
                    throw new Error("Token utg√•ngen (401). Du m√•ste h√§mta en ny Access Token via PowerShell.");
                }
                if (!response.ok) {
                    throw new Error(`Spotify API-fel: ${response.status} ${response.statusText}.`);
                }

                const data = await response.json();
                const tracks = data.items.filter(item => item.track); 
                
                // 3. Filtrera och v√§lj l√•t
                const tracksWithPreview = tracks.filter(item => item.track.preview_url !== null);

                if (tracksWithPreview.length === 0) {
                    outputElement.innerHTML = `<p class="error">‚ùå Kunde inte hitta fler l√•tar fr√•n **${selectedDecade}** med f√∂rhandsvisning.</p>`;
                    return;
                }

                const randomIndex = Math.floor(Math.random() * tracksWithPreview.length);
                const randomTrack = tracksWithPreview[randomIndex].track;
                const artistName = randomTrack.artists.map(a => a.name).join(', ');
                
                // EXTRA ANROP: H√§mta albumdata f√∂r Utgivnings√•r (release_date)
                // Obs: Detta steg kr√§ver ett extra API-anrop per l√•t, vilket kan vara l√•ngsamt
                let releaseYear = 'Ok√§nt';
                if (randomTrack.album?.id) {
                    const albumUrl = `https://api.spotify.com/v1/...{randomTrack.album.id}`;
                    const albumResponse = await fetch(albumUrl, {
                        headers: { 'Authorization': `Bearer ${SPOTIFY_ACCESS_TOKEN}` }
                    });
                    if (albumResponse.ok) {
                        const albumData = await albumResponse.json();
                        releaseYear = albumData.release_date ? albumData.release_date.substring(0, 4) : 'Ok√§nt';
                    }
                }
                
                // Lagra facit
                currentAnswer = {
                    artist: artistName.toLowerCase().split(' & ')[0], // Enkelt format
                    title: randomTrack.name.toLowerCase().replace(/ \(.+\)/, ''), // Ta bort t.ex. (Remastered)
                    year: releaseYear,
                    preview_url: randomTrack.preview_url
                };

                // 4. Visa L√•tinformation och Spela Upp
                outputElement.innerHTML = `
                    <h2>‚ñ∂Ô∏è Spelar Klipp...</h2>
                    <p><strong>√Örtionde:</strong> ${selectedDecade}</p>
                    <p class="success">Lyssna noga! G√∂r din gissning i f√§ltet nedan.</p>
                    <audio controls autoplay src="${randomTrack.preview_url}"></audio>
                `;
                
                document.getElementById('guess-section').style.display = 'block'; // Visa gissningsf√§ltet

            } catch (error) {
                console.error("Fel vid laddning av l√•t:", error);
                outputElement.innerHTML = `<p class="error">üõë Ett allvarligt fel uppstod: ${error.message}.</p>`;
            }
        }

        /**
         * R√§ttar gissningen, ber√§knar po√§ng och uppdaterar spelarlistan.
         */
        function submitGuess() {
            if (!currentAnswer) {
                alert("Starta en ny runda f√∂rst!");
                return;
            }

            const playerId = document.getElementById('current-player-select').value;
            const playerIndex = players.findIndex(p => p.id == playerId);
            const player = players[playerIndex];

            // 1. H√§mta gissningar
            const guessArtist = document.getElementById('guess-artist').value.trim().toLowerCase();
            const guessTitle = document.getElementById('guess-title').value.trim().toLowerCase();
            const guessYear = document.getElementById('guess-year').value.trim();

            let correctCount = 0;
            let currentPoints = 0;
            let feedback = '<ul>';

            // 2. R√§ttningslogik (enkel j√§mf√∂relse)
            const artistCorrect = currentAnswer.artist.includes(guessArtist) && guessArtist.length > 2;
            const titleCorrect = currentAnswer.title.includes(guessTitle) && guessTitle.length > 2;
            const yearCorrect = currentAnswer.year === guessYear;
            
            if (artistCorrect) { correctCount++; feedback += '<li>‚úÖ Artist: R√§tt!</li>'; } else { feedback += `<li>‚ùå Artist: Fel. R√§tt svar var: ${currentAnswer.artist}</li>`; }
            if (titleCorrect) { correctCount++; feedback += '<li>‚úÖ Titel: R√§tt!</li>'; } else { feedback += `<li>‚ùå Titel: Fel. R√§tt svar var: ${currentAnswer.title}</li>`; }
            if (yearCorrect) { correctCount++; feedback += '<li>‚úÖ √Ör: R√§tt!</li>'; } else { feedback += `<li>‚ùå √Ör: Fel. R√§tt svar var: ${currentAnswer.year}</li>`; }

            // 3. Po√§ngber√§kning
            if (correctCount === 3) {
                currentPoints = 5; // 5 po√§ng f√∂r allt r√§tt
            } else {
                currentPoints = correctCount; // 1 po√§ng per r√§tt svar
            }

            // 4. Uppdatera po√§ngen
            player.score += currentPoints;
            
            // 5. Visa resultat och uppdatera gr√§nssnittet
            const finalFeedback = `
                <h2>‚≠ê Po√§ng R√§ttade!</h2>
                <p><strong>${player.name}</strong> fick <strong>${currentPoints} po√§ng</strong> i denna runda.</p>
                <p>Totalt: ${player.score} po√§ng.</p>
                ${feedback}</ul>
                <p>R√§tt l√•t: <strong>${currentAnswer.artist} - ${currentAnswer.title} (${currentAnswer.year})</strong></p>
            `;
            
            document.getElementById('quiz-output').innerHTML = finalFeedback;
            document.getElementById(`player-${player.id}`).innerHTML = `<strong>${player.name}:</strong> ${player.score} po√§ng`;
            document.getElementById('guess-section').style.display = 'none'; // D√∂lj gissningsf√§ltet

            // √Öterst√§ll gissningsf√§lten
            document.getElementById('guess-artist').value = '';
            document.getElementById('guess-title').value = '';
            document.getElementById('guess-year').value = '';
        }
    </script>
</body>
</html>