<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reine Lindqvist's Musikquiz - Dashboard</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            padding: 30px;
            background-color: #f4f4f9;
            color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        h1 {
            color: #1DB954;
            text-align: center;
            width: 100%;
            margin-bottom: 25px;
        }
        .control-panel, .score-dashboard {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background-color: #fafafa;
            flex: 1;
            min-width: 350px;
        }
        .control-panel h3, .score-dashboard h3 {
            margin-top: 0;
            color: #1DB954;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        .decade-choices {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        label { cursor: pointer; }
        input[type="text"], input[type="number"], button, select {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        button {
            background-color: #1DB954;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #17a447; }
        
        /* Dashboard Styling */
        .score-dashboard { order: -1; /* Visas f√∂rst */ }
        .player-list { list-style: none; padding: 0; }
        .player-list li {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px dotted #ccc;
            font-size: 1.1em;
        }
        .current-player {
            background-color: #ffe0b2; /* L√§tt orange f√∂r att markera aktiv spelare */
            font-weight: bold;
        }
        .quiz-output {
            width: 100%;
            padding: 20px;
            border: 2px solid #eee;
            border-radius: 8px;
            background-color: #fafafa;
            margin-top: 20px;
        }
        .error { color: #ff4d4d; font-weight: bold; }
        .success { color: #1DB954; font-weight: bold; }
        audio { width: 100%; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üéµ Musikquiz: Spelledarpanel</h1>
        
        <div class="control-panel">
            <h3>Spelinst√§llningar</h3>
            
            <label for="num-players">Antal spelare (1-10):</label>
            <input type="number" id="num-players" min="1" max="10" value="1" onchange="setupPlayers()">
            
            <div id="player-names-input">
                </div>
            
            <hr style="margin: 15px 0;">

            <h3>V√§lj √Örtionden</h3>
            <div id="decade-choices" class="decade-choices">
                <label><input type="checkbox" value="60s" checked> 60-talet</label>
                <label><input type="checkbox" value="70s" checked> 70-talet</label>
                <label><input type="checkbox" value="80s" checked> 80-talet</label>
                <label><input type="checkbox" value="90s" checked> 90-talet</label>
                <label><input type="checkbox" value="00s" checked> 2000-talet</label>
                <label><input type="checkbox" value="10s" checked> 2010-talet</label>
                <label><input type="checkbox" value="20s" checked> 2020-talet</label>
            </div>
            <button onclick="startNewRound()">Starta Ny Quiz-Runda</button>
        </div>

        <div class="score-dashboard">
            <h3>Po√§ngst√§llning</h3>
            <p id="current-player-status">Konfigurera spelet och klicka Starta Runda.</p>
            <ul id="player-scores" class="player-list">
                </ul>
        </div>
        
        <div id="quiz-output" class="quiz-output">
            <p>V√§lj inst√§llningar och klicka p√• **Starta Ny Quiz-Runda**.</p>
        </div>
        
        <div id="scoring-section" class="quiz-output" style="display: none; width: 100%;">
            <h3>Po√§nginmatning</h3>
            <p id="current-player-scoring"></p>
            
            <label for="input-score">Ange erh√•llna po√§ng (0, 1, 2, 3 eller 5):</label>
            <input type="number" id="input-score" min="0" max="5" value="0">
            
            <button onclick="submitScore()">L√•ten R√§ttad & Ge Po√§ng</button>
        </div>
    </div>

    <script>
        // *******************************************************************
        // KONTROLLPUNKT 1: ACCESS TOKEN √ÑR INKLUDERAD H√ÑR
        // Token √§r giltig i ca 1 timme.
        const SPOTIFY_ACCESS_TOKEN = "BQD5RnGLbY5ifxE_45Kw2yqgDs0PDS0N_wwAZZiUwBmhO1ebupAm1CG8nNJTS0tpivranD3xhBGDtHbJFz7h8LhnVVvVdT6GTzmI_3sn_IwR4ZnnZivSy1Kfmdz...
"; 
        // *******************************************************************

        // Globala variabler f√∂r speldata
        let players = [];
        let currentPlayerIndex = 0; // Index f√∂r den spelare vars tur det √§r (b√∂rjar p√• 0)
        
        // Spotify API-konstanter
        const playlistSources = {
            '60s': '37i9dQZF1DXcKqP3JdK0pQ', 
            '70s': '37i9dQZF1DWTJg7XNnKFE3', 
            '80s': '37i9dQZF1DXcBWIGoYBM5M', 
            '90s': '37i9dQZF1DXbTjV1dE9zY7', 
            '00s': '37i9dQZF1DX4oNzlhCrbxM', 
            '10s': '37i9dQZF1DX5BAW6M0K4Vf', 
            '20s': '37i9dQZF1DXcBWIGoYBM5M',
        };
        const MAX_SONGS_TO_CHECK = 100; 

        // Initialiserar spelarlistan vid start
        setupPlayers(); 

        /** * Hanterar inst√§llning och visning av spelare (namn och po√§ng)
         */
        function setupPlayers() {
            const num = parseInt(document.getElementById('num-players').value);
            const nameInputDiv = document.getElementById('player-names-input');
            
            // 1. Hantera namninmatningsf√§lten
            nameInputDiv.innerHTML = '';
            // Skapa tempor√§r array f√∂r att h√•lla reda p√• befintliga namn/po√§ng
            let tempPlayers = [];
            for (let i = 1; i <= num; i++) {
                const existingPlayer = players.find(p => p.id === i) || { name: `Spelare ${i}`, score: 0 };
                
                nameInputDiv.innerHTML += `
                    <input type="text" id="player-name-${i}" placeholder="Namn Spelare ${i}" value="${existingPlayer.name}">
                `;
                tempPlayers.push({ id: i, name: existingPlayer.name, score: existingPlayer.score });
            }
            
            // 2. Uppdatera spelarlistan i players[]
            players = tempPlayers;
            
            // Rita om Dashboard och markera aktuell spelare
            updateDashboard();
        }

        /**
         * Uppdaterar po√§ngst√§llningen i Dashboard och markerar aktuell spelare.
         */
        function updateDashboard() {
            const playerList = document.getElementById('player-scores');
            const status = document.getElementById('current-player-status');
            
            // Spara eventuella nya namn fr√•n inputf√§lten
            players.forEach((player, index) => {
                const nameInput = document.getElementById(`player-name-${player.id}`);
                if (nameInput) {
                    player.name = nameInput.value.trim();
                }
            });
            
            // Sortera spelare efter po√§ng (h√∂gst f√∂rst)
            const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
            
            playerList.innerHTML = '';
            sortedPlayers.forEach((player, index) => {
                const isCurrent = player.id === players[currentPlayerIndex]?.id;
                playerList.innerHTML += `
                    <li id="player-score-id-${player.id}" class="${isCurrent ? 'current-player' : ''}">
                        <span>${player.name}</span>
                        <span>${player.score} po√§ng</span>
                    </li>
                `;
            });
            
            const activePlayer = players[currentPlayerIndex];
            if (activePlayer) {
                status.innerHTML = `<strong>N√§sta:</strong> ${activePlayer.name}'s tur att gissa.`;
                // Se till att den aktiva spelaren √§r markerad korrekt efter sortering
                document.getElementById(`player-score-id-${activePlayer.id}`)?.classList.add('current-player');
            }
        }
        
        /**
         * V√§ljer ett slumpm√§ssigt √•rtionde fr√•n de markerade.
         */
        function selectRandomDecade() {
            const checkboxes = document.querySelectorAll('#decade-choices input[type="checkbox"]:checked');
            if (checkboxes.length === 0) return null;

            const selectedDecades = Array.from(checkboxes).map(cb => cb.value);
            const randomIndex = Math.floor(Math.random() * selectedDecades.length);
            return selectedDecades[randomIndex];
        }

        /**
         * Startar en ny omg√•ng genom att h√§mta och spela upp en l√•t.
         */
        async function startNewRound() {
            setupPlayers(); // Spara eventuella nya spelarnamn och uppdatera listan
            
            const selectedDecade = selectRandomDecade();
            const outputElement = document.getElementById('quiz-output');
            
            document.getElementById('scoring-section').style.display = 'none'; // D√∂lj po√§ngf√§ltet

            if (players.length === 0 || players[0].name === 'Spelare 1') {
                // Enkel check f√∂r att s√§kerst√§lla att spelare √§r konfigurerade
                outputElement.innerHTML = `<p class="error">‚ùå V√§nligen ange spelare (minst en) och deras namn.</p>`;
                return;
            }
            if (!selectedDecade) {
                outputElement.innerHTML = `<p class="error">‚ùå V√§nligen v√§lj minst ett √•rtionde att spela fr√•n.</p>`;
                return;
            }
            if (SPOTIFY_ACCESS_TOKEN.length < 50) { // Enkel l√§ngdkontroll
                outputElement.innerHTML = `<p class="error">‚ùå FEL: Din Access Token verkar vara inkorrekt eller utg√•ngen.</p>`;
                return;
            }
            
            const playlistId = playlistSources[selectedDecade];
            outputElement.innerHTML = `<p class="success">Laddar l√•t f√∂r **${players[currentPlayerIndex].name}** fr√•n ${selectedDecade}... V√§nligen v√§nta...</p>`;

            try {
                // RIKTIGT API-ANROP till Spotify
                const apiUrl = `https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=${MAX_SONGS_TO_CHECK}`;
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${SPOTIFY_ACCESS_TOKEN}` 
                    }
                });

                if (response.status === 401) {
                    throw new Error("Token utg√•ngen (401). Du m√•ste h√§mta en ny Access Token via PowerShell.");
                }
                if (!response.ok) {
                    throw new Error(`Spotify API-fel: ${response.status} ${response.statusText}.`);
                }

                const data = await response.json();
                const tracks = data.items.filter(item => item.track); 
                
                // Filtrera och v√§lj l√•t
                const tracksWithPreview = tracks.filter(item => item.track.preview_url !== null);

                if (tracksWithPreview.length === 0) {
                    outputElement.innerHTML = `<p class="error">‚ùå Kunde inte hitta fler l√•tar fr√•n **${selectedDecade}** med f√∂rhandsvisning.</p>`;
                    return;
                }

                const randomIndex = Math.floor(Math.random() * tracksWithPreview.length);
                const randomTrack = tracksWithPreview[randomIndex].track;
                const artistName = randomTrack.artists.map(a => a.name).join(', ');
                
                // 4. Visa L√•tinformation och Spela Upp
                outputElement.innerHTML = `
                    <h2>‚ñ∂Ô∏è Spelar Klipp f√∂r ${players[currentPlayerIndex].name}...</h2>
                    <p><strong>√Örtionde:</strong> ${selectedDecade}</p>
                    <p class="success">L√•t **${players[currentPlayerIndex].name}** gissa. Klippet spelas upp.</p>
                    <audio controls autoplay src="${randomTrack.preview_url}"></audio>
                    <hr>
                    <p><strong>R√ÑTT SVAR (F√∂r Spelledaren):</strong> ${artistName} - ${randomTrack.name}</p>
                `;
                
                // F√∂rbered po√§nginmatningssektionen
                document.getElementById('current-player-scoring').innerHTML = `
                    **${players[currentPlayerIndex].name}** gissade nyss. Mata in deras po√§ng:
                `;
                document.getElementById('scoring-section').style.display = 'block';

            } catch (error) {
                console.error("Fel vid laddning av l√•t:", error);
                outputElement.innerHTML = `<p class="error">üõë Ett allvarligt fel uppstod: ${error.message}.</p>`;
            }
        }

        /**
         * Hanterar po√§nginmatning av spelledaren och g√•r vidare till n√§sta spelare.
         */
        function submitScore() {
            const scoreInput = parseInt(document.getElementById('input-score').value);
            const maxScore = 5;

            if (scoreInput < 0 || scoreInput > maxScore || isNaN(scoreInput)) {
                alert(`Po√§ng m√•ste vara mellan 0 och ${maxScore}.`);
                return;
            }
            
            const player = players[currentPlayerIndex];
            const currentAudio = document.querySelector('#quiz-output audio');
            if (currentAudio) {
                currentAudio.pause(); // Stoppa uppspelningen n√§r po√§ngen ges
            }
            
            player.score += scoreInput;
            
            // Visa feedback
            const feedback = `
                <h2>‚≠ê Runda Avslutad!</h2>
                <p><strong>${player.name}</strong> fick <strong>${scoreInput} po√§ng</strong>.</p>
                <p>Total po√§ng: ${player.score}.</p>
                <p class="success"><strong>KLICKA P√Ö STARTA NY QUIZ-RUNDA F√ñR ATT G√Ö VIDARE TILL N√ÑSTA SPELARE!</strong></p>
            `;
            
            document.getElementById('quiz-output').innerHTML = feedback;
            document.getElementById('scoring-section').style.display = 'none';

            // G√• vidare till n√§sta spelare (cirkul√§rt)
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            
            // √Öterst√§ll po√§ngf√§ltet och uppdatera dashboarden
            document.getElementById('input-score').value = 0;
            updateDashboard();
        }
        
        // Se till att spelarnamn och dashboard uppdateras n√§r antal spelare √§ndras
        document.getElementById('num-players').addEventListener('change', setupPlayers);
        
        // L√§gg till en lyssnare p√• input-f√§lten f√∂r spelarnamn (m√•ste k√∂ras efter setupPlayers)
        document.getElementById('player-names-input').addEventListener('input', updateDashboard);
        
        // K√∂r setupPlayers igen f√∂r att hantera namnf√§lten vid laddning
        setupPlayers();

    </script>
</body>
</html>